# This file defines what ends up in the CD boot image and it executes the
# rules building the image.

#HAIKU_BOOT_FLOPPY = haiku-boot-floppy.image ;
#MakeLocate $(HAIKU_BOOT_FLOPPY) : $(HAIKU_OUTPUT_DIR) ;

# CD image target
HAIKU_CD_BOOT_IMAGE = haiku-boot-cd.iso ;
MakeLocate $(HAIKU_CD_BOOT_IMAGE) : $(HAIKU_OUTPUT_DIR) ;

# the pseudo target all archive contents is attached to
NotFile $(HAIKU_CD_BOOT_IMAGE_CONTAINER_NAME) ;

# common extra files to put on the boot iso
local extras = README.html ;
SEARCH on $(extras) = [ FDirName $(HAIKU_TOP) data boot extras ] ;

{
	# For other platforms, we have to check which bootloader is used. There
	# can be multiple ones, making this a bit confusing.
	for platform in [ MultiBootSubDirSetup ] {
		on $(platform) {
			if $(TARGET_BOOT_PLATFORM) = efi {
				local efiLoader = haiku_loader.efi ;
				local efiPartition = esp.image ;
				local bootMBR = base_mbr.bin ;
				MakeLocateDebug $(efiPartition) : system boot ;
				BuildEfiSystemPartition $(efiPartition) : $(efiLoader) ;

				BuildCDBootImageEFI $(HAIKU_CD_BOOT_IMAGE) : $(bootMBR)
					: $(efiPartition) : $(extras) ;
			}
			if $(TARGET_BOOT_PLATFORM) = bios_ia32 {
				local biosLoader = haiku_loader.bios_ia32 ;
				local bootMBR = base_mbr.bin ;

				BuildCDBootImageBIOS $(HAIKU_CD_BOOT_IMAGE) : $(bootMBR)
					: $(biosLoader) : $(extras) ;
			}
		}
	}
}

NotFile haiku-boot-cd ;
Depends haiku-boot-cd : $(HAIKU_CD_BOOT_IMAGE) ;
