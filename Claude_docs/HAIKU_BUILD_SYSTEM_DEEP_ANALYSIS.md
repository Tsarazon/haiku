# HAIKU BUILD SYSTEM DEEP ANALYSIS

## Current Issue: Package Architecture Mismatch

### Problem Summary
- All external packages in `generated/download/` have incorrect architecture metadata
- Packages show `architecture: riscv64` instead of `x86_64` 
- This causes the package dependency resolver to reject them as incompatible
- Build fails during final image creation at package resolution stage

### Build System Architecture

#### 1. Core Build Files Structure
```
build/jam/
├── images/
│   ├── HaikuImage                      # Main image builder
│   ├── definitions/
│   │   ├── minimum                     # Minimal system packages
│   │   ├── regular                     # Full system packages  
│   │   └── common-tail                 # Common image setup
│   └── AnybootImage, CDBootImage, etc.
├── repositories/
│   ├── HaikuPorts/x86_64              # External package definitions
│   └── HaikuPortsCross/x86_64         # Bootstrap packages
├── OptionalPackages                    # Optional package definitions
└── HaikuPackages                       # Core Haiku package rules
```

#### 2. Package Selection Flow
1. `images/HaikuImage` includes `definitions/regular`
2. `definitions/regular` includes `definitions/minimum` 
3. `common-tail` includes `OptionalPackages`
4. External packages come from `repositories/HaikuPorts/x86_64`

#### 3. Package Repository Analysis
File: `build/jam/repositories/HaikuPorts/x86_64`
- Contains 200+ external packages including bash, coreutils, gcc_syslibs
- These packages are downloaded to `generated/download/`
- Problem: Downloaded packages have wrong architecture metadata

### Root Cause Analysis

#### Issue Location
The problem is NOT in the build system configuration, but in the downloaded packages themselves. The packages:
- Have correct filenames: `bash-5.2.032-1-x86_64.hpkg`
- Have wrong internal metadata: `architecture: riscv64`

#### Evidence
```bash
generated/objects/linux/x86_64/release/tools/package/package list generated/download/jasper-2.0.33-1-x86_64.hpkg
# Shows: architecture: riscv64  <-- WRONG!
```

### Build Progress Analysis
The build system WORKS correctly and builds:
- 1015+ targets successfully
- All core Haiku packages (haiku.hpkg, haiku_loader.hpkg, haiku_datatranslators.hpkg)
- Gets to image creation stage
- Fails only at final package dependency resolution

### Solutions Investigated

#### 1. ❌ Edit Generated Files
Attempted to edit `generated/haiku.image-init-vars` but file gets regenerated by build system.

#### 2. ❌ Disable Dependency Resolution  
Setting `resolvePackageDependencies="0"` gets overridden.

#### 3. ✅ Remove External Packages
Currently removing all external packages to build minimal core-only image.

### Next Steps
1. Build minimal image with only core Haiku packages
2. Create ISO from minimal image
3. Investigate downloading correct x86_64 packages from different repository
4. Document package repository configuration options

### Build System Configuration Points

#### Key Variables
- `HAIKU_BUILD_TYPE`: bootstrap/minimum/regular
- `systemPackages`: List of packages to include
- `resolvePackageDependencies`: Enable/disable dependency resolution

#### Configuration Files
- `configure`: Main configuration script
- `build/jam/images/definitions/`: Package selection
- `build/jam/repositories/`: Package sources
- User configuration possible via build profiles

### Documentation References from Haiku Developer Docs

#### Build System Architecture (from haiku-os.org/docs/develop/)

**Jam Build Tool**:
- Custom Jam variant developed specifically for Haiku's needs
- Automatic dependency tracking for C++ source files
- Support for multiple compilers and target architectures
- Handles complex build tasks beyond code compilation
- Support for multi-step target building and filesystem image generation

**Key Build Rule Files**:
- `OverriddenJamRules`: Redefine default build rules
- `BeOSRules`: Manage extended attributes
- `MainBuildRules`: Define application/library build rules
- `ArchitectureRules`: Handle compiler flags for different architectures
- `BootRules`: Build bootloaders
- `KernelRules`: Build kernel and kernel add-ons

**Configure Script**:
- Simple shell script for build configuration (no autotools)
- Sets up required configuration for building Haiku
- Supports limited set of host architectures
- Builds GCC cross-compiler for Haiku targets
- Largely self-contained

#### Source Code Organization

**Directory Structure** (mirrors Haiku filesystem):
```
src/
├── add-ons/          # Kernel drivers, media codecs
├── apps/             # GUI applications
├── bin/              # Command-line tools
├── kits/             # Public C++ API
└── system/           # Low-level system components
```

**Repository Management**:
- Primary repositories:
  1. Main OS sources: http://cgit.haiku-os.org/haiku
  2. Build tools: http://cgit.haiku-os.org/buildtools
  3. HaikuPorts packages on GitHub

**Third-Party Code Management**:
- Uses "vendor branches" for tracking upstream changes (GCC, binutils)
- Allows easy merging and tracking of upstream updates
- For smaller imports, changes marked with `__HAIKU__` preprocessor guards

#### Package Management System

**Package Generation**:
- Pre-compiled packages downloaded during build from repositories
- Packages built using Haikuporter
- Recipes available on GitHub (haikuports repositories)
- Repository URL: `https://eu.hpkg.haiku-os.org/haikuports/master/build-packages`

**Package Distribution**:
- HaikuDepot: Central application for package management
- Supports multiple repositories (local and online)
- Package status tracking (Active, Available, Pending)
- User account system for ratings and comments
- Diagnostic logging for troubleshooting

**Repository Configuration**:
- Repositories can be added/removed through HaikuDepot
- Enable/disable repositories
- Check for software updates
- Support for both online and local repositories

#### Build System Requirements

**Key Capabilities**:
- Automatic dependency tracking for C++ source files
- Support for multiple compilers and target architectures
- Complex build tasks beyond code compilation
- Multi-step target building
- Configurability for filesystem image generation

**Development Process**:
- Uses Git for source control
- Uses Gerrit for code change reviews
- Comprehensive documentation for developers

### Architecture-Specific Package Issues

**Root Cause Analysis**:
Based on documentation research and build analysis, the architecture mismatch issue (packages showing `riscv64` instead of `x86_64`) appears to be:

1. **Repository Mirror Issues**: The European HaikuPorts mirror may have incorrect package metadata
2. **Package Build Configuration**: Packages may have been built with wrong architecture flags
3. **Download Script Issues**: Package download mechanism may be fetching from wrong architecture repository

**Potential Solutions**:
1. **Alternative Repository**: Try different HaikuPorts mirror or repository branch
2. **Local Package Building**: Use Haikuporter to build packages locally with correct architecture
3. **Minimal Build**: Create core-only image without external packages (current approach)
4. **Repository Configuration**: Modify repository URLs in `build/jam/repositories/HaikuPorts/x86_64`

### Next Investigation Steps

#### Package Repository URLs
- Check if repository URL in `build/jam/repositories/HaikuPorts/x86_64` is correct
- Investigate alternative mirrors or repository branches
- Verify package download mechanism in build scripts

#### Build Configuration Options
- Research `configure` script options for repository selection
- Investigate build profiles for minimal/bootstrap builds
- Check for architecture-specific build flags

## Current Status
Building minimal core-only image to bypass external package architecture issues while investigating repository configuration options.